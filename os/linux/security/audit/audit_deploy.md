> Red Hat Enterprise Linuxçš„ã€Šå®‰å…¨æ€§æŒ‡å—ã€‹å†™ğ¢”¶éå¸¸è¯¦å°½ï¼Œæœ¬æ–‡æ˜¯é˜…è¯»å­¦ä¹ è¿‡ç¨‹åŸºæœ¬åªåšäº†æ¬è¿ï¼Œè¯¦ç»†æ¡ˆä¾‹è¯·å‚è€ƒå®è·µï¼š

* [æ‰¾å‡ºç¬é—´æ¶ˆå¤±çš„TCPç½‘ç»œè¿æ¥è¿›ç¨‹](find_short_lived_tcp_connections_owner_process)

# ç³»ç»Ÿå®¡è®¡`audit`è½¯ä»¶åŒ…

ç³»ç»Ÿå®¡è®¡è½¯ä»¶åŒ… `audit` å’Œ `audit-libs` æ˜¯é»˜è®¤å®‰è£…åœ¨RHELç³»ç»Ÿä¸­çš„ã€‚

# é…ç½®`audit`æœåŠ¡

å®¡æ ¸å®ˆæŠ¤ç¨‹åºå¯ä»¥åœ¨ `/etc/audit/auditd.conf` é…ç½®æ–‡ä»¶ä¸­è¿›è¡Œé…ç½®ã€‚è¿™ä¸ªæ–‡ä»¶åŒ…æ‹¬ä¿®æ”¹å®¡æ ¸å®ˆæŠ¤è¿›ç¨‹ç‰¹æ€§çš„é…ç½®å‚æ•°ã€‚

æ‰€æœ‰é…ç½®å‚æ•°çš„åˆ—è¡¨ä»¥åŠå®ƒä»¬çš„è§£é‡Šéƒ½å¯ä»¥åœ¨ `audit.conf(5)` æ‰‹å†Œé¡µä¸­æ‰¾åˆ°ã€‚

# ä¸ºäº† åœ¨ `CAPP` ç¯å¢ƒé…ç½® `auditd`

é»˜è®¤ `auditd` é…ç½®åº”è¯¥å¯¹å¤§å¤šæ•°ç¯å¢ƒéƒ½é€‚åˆã€‚ä½†æ˜¯å¯æ§åˆ¶å­˜å–ä¿æŠ¤æ¡£æ¡ˆï¼ˆ`CAPP`ï¼‰æ‰€å»ºç«‹çš„æ ‡å‡†æ˜¯å…¬å…±æ ‡å‡†è®¤è¯çš„ä¸€éƒ¨åˆ†ï¼Œå®¡æ ¸å®ˆæŠ¤ç¨‹åºå¿…é¡»ç”¨ä»¥ä¸‹è®¾å®šé…ç½®ï¼š

* ä¿å­˜å®¡æ ¸æ—¥å¿—æ–‡ä»¶çš„ç›®å½•ï¼ˆ`/var/log/audit/`ï¼‰ç»å¸¸åº”è¯¥åœ¨å¦ä¸€ä¸ªåˆ†åŒºã€‚è¿™å°†é˜²æ­¢å…¶ä»–è¿›ç¨‹è€—è´¹æ­¤ç›®å½•ä¸­çš„ç©ºé—´ï¼Œå¹¶ä¸”ä¸ºå‰©ä½™çš„å®¡æ ¸å®ˆæŠ¤ç¨‹åºæä¾›å‡†ç¡®çš„æ£€æµ‹ã€‚

* `max_log_file` å‚æ•°è¯¦ç»†è¯´æ˜äº†æ¯ä¸ªå®¡æ ¸æ—¥å¿—æ–‡ä»¶æœ€å°‘çš„å ç”¨ç©ºé—´ï¼Œå‚æ•°å¿…é¡»è®¾å®šä¸ºå……åˆ†åˆ©ç”¨ä¿å­˜å®¡æ ¸æ—¥å¿—æ–‡ä»¶åˆ†åŒºæ‰€åœ¨çš„å¯ç”¨ç©ºé—´ã€‚

* `max_log_file_action` å‚æ•°å†³å®šé‡‡å–ä½•ç§è¡ŒåŠ¨ï¼Œä¸€æ—¦åˆ°è¾¾åœ¨`max_log_file`ä¸­æ‰€è®¾å®šçš„æé™ï¼Œåˆ™åº”è¯¥è®¾å®šä¸º `keep_logs` é˜²æ­¢å®¡æ ¸æ—¥å¿—æ–‡ä»¶è¢«é‡å†™ã€‚

* `space_left` å‚æ•°æ˜ç¡®è¯´æ˜ç£ç›˜ä¸­å¯ç”¨ç©ºé—´çš„æ•°é‡ï¼Œè¿™æ ·çš„è¯åœ¨`space_left_action` å‚æ•°ä¸­æ‰€è®¾å®šçš„è¡ŒåŠ¨ä¼šè¢«è§¦å‘ã€‚æ­¤å‚æ•°å¿…é¡»è¢«è®¾å®šä¸ºä¸€ä¸ªæ•°å­—å®ƒä¼šç»™äºˆç®¡ç†è€…è¶³å¤Ÿçš„æ—¶é—´æ¥å›åº”å’Œåˆ·æ–°ç£ç›˜ç©ºé—´ã€‚ `space_left` ä»·å€¼å–å†³äºå®¡æ ¸æ—¥å¿—æ–‡ä»¶ç”Ÿæˆçš„é€Ÿåº¦ã€‚

> æ¨èé‡‡ç”¨åˆé€‚çš„é€šçŸ¥æ–¹æ³•æŠŠ `space_left_action` å‚æ•°è®¾å®šä¸º`email` æˆ–è€… `exec`ã€‚

* `admin_space_left` å‚æ•°æ˜ç¡®è¯´æ˜è‡ªç”±ç©ºé—´çš„ç»å¯¹æœ€å°æ•°é‡ï¼Œä¸ºäº†åœ¨ `admin_space_left_action` å‚æ•°ä¸­æ‰€è®¾å®šçš„è¡ŒåŠ¨ä¼šè¢«è§¦å‘ï¼Œå¿…é¡»è®¾å®šä¸€ä¸ªä¼šç»™äºˆç®¡ç†è€…çš„æ—¥å¿—è¡ŒåŠ¨æ€»å¤Ÿç©ºé—´çš„å€¼ã€‚

* `admin_space_left_action` å‚æ•°å¿…é¡»è®¾å®š `single` ä½¿ç³»ç»Ÿå±äºå•ä¸€ç”¨æˆ·æ¨¡å¼ï¼Œå¹¶ä¸”å…è®¸ç®¡ç†è€…å¼€æ”¾ä¸€äº›ç£ç›˜ç©ºé—´ã€‚

* `disk_full_action` å‚æ•°æ˜ç¡®è¯´æ˜å½“ä¿å­˜å®¡æ ¸æ—¥å¿—æ–‡ä»¶çš„åˆ†åŒºæ²¡æœ‰å¯ç”¨ç©ºé—´æ—¶ï¼Œåº”è¯¥è§¦å‘è¡ŒåŠ¨ï¼Œå¹¶ä¸”å¿…é¡»è®¾å®šä¸º `halt` æˆ–è€… `single`ã€‚è¿™ä¿éšœäº†å½“å®¡æ ¸ä¸å†è®°å½•äº‹ä»¶æ—¶ï¼Œç³»ç»Ÿä¹Ÿèƒ½åœ¨å•ä¸€ç”¨æˆ·æ¨¡å¼ä¸‹å…³é—­æˆ–è€…è¿è¡Œã€‚

* `disk_error_action`ï¼Œæ˜ç¡®è¯´æ˜å¦‚æœä¿å­˜åœ¨å®¡æ ¸æ—¥å¿—æ–‡ä»¶çš„åˆ†åŒºæ£€æµ‹åˆ°é”™è¯¯æ—¶ï¼Œåº”è¯¥é‡‡å–è¡ŒåŠ¨ï¼Œå¿…é¡»è®¾å®š `syslog`ã€`single` æˆ–è€… `halt`ï¼Œè¿™å–å†³äºå½“åœ°çš„å®‰å…¨æ”¿ç­–æœ‰å…³ç¡¬ä»¶æ•…éšœçš„å¤„ç†ã€‚

* `flush` é…ç½®å‚æ•°å¿…é¡»è®¾å®šä¸º `sync` æˆ–è€… `data`ã€‚è¿™äº›å‚æ•°ä¿è¯æ‰€æœ‰çš„å®¡æ ¸äº‹ä»¶æ•°æ®èƒ½ä¸ç£ç›˜ä¸­çš„æ—¥å¿—æ–‡ä»¶åŒæ­¥ã€‚

# å¼€å§‹`audit`æœåŠ¡

* å¯åŠ¨`auditd`æœåŠ¡

```
service auditd start
```

> `auditd`æœåŠ¡å¯åŠ¨åŠ¨ä½œä¸­è¿˜æ”¯æŒ`reload`ï¼ˆé‡æ–°åŠ è½½é…ç½®ï¼‰å’Œ`rotate`ï¼ˆè½®è½¬`/var/log/audit/`ç›®å½•æ—¥å¿—æ–‡ä»¶ï¼‰ã€‚

* æ¿€æ´»ç³»ç»Ÿå¯åŠ¨æ—¶å¯åŠ¨`auditd`

```
chkconfig auditd on
```

# å®šä¹‰å®¡æ ¸è§„åˆ™

å®¡æ ¸ç³»ç»Ÿæ ¹æ®ä¸€ç»„è§„åˆ™è¿è¡Œï¼Œè¿™ç»„è§„åˆ™å®šä¹‰äº†æ—¥å¿—æ–‡ä»¶ä¸­æ‰€è·å–çš„å†…å®¹ã€‚æœ‰ä¸‰ç§ç±»å‹çš„å®¡æ ¸è§„åˆ™å¯ä»¥è¯¦ç»†è¯´æ˜ï¼š

* æ§åˆ¶è§„åˆ™ â€” å…è®¸å®¡æ ¸ç³»ç»Ÿçš„è¡Œä¸ºå’Œå®ƒçš„ä¸€äº›è¢«ä¿®æ”¹çš„é…ç½®ã€‚
* æ–‡ä»¶ç³»ç»Ÿè§„åˆ™ â€” ä¹Ÿè¢«ç§°ä¸ºæ–‡ä»¶ç›‘è§†ï¼Œå…è®¸å®¡æ ¸è¿›å…¥ç‰¹å®šæ–‡ä»¶æˆ–è€…ç›®å½•ã€‚
* ç³»ç»Ÿè°ƒç”¨è§„åˆ™ â€” å…è®¸è®°å½•ä»»ä½•æŒ‡å®šç¨‹åºæ‰€åšçš„ç³»ç»Ÿè°ƒç”¨ã€‚

å®¡æ ¸è§„åˆ™å¯ä»¥åœ¨å‘½ä»¤è¡Œä¸Šä½¿ç”¨ `auditctl` å®ç”¨ç¨‹åºè¿›è¡Œè¯¦ç»†è¯´æ˜ï¼ˆè¯·æ³¨æ„è¿™äº›è§„åˆ™å¹¶ä¸æ˜¯åœ¨é‡æ–°å¯åŠ¨æ—¶ä¸€ç›´æœ‰æ•ˆï¼‰ï¼Œæˆ–è€…å†™åœ¨ `/etc/audit/audit.rules` æ–‡ä»¶ä¸­ã€‚

# ä½¿ç”¨ auditctl å®ç”¨ç¨‹åºæ¥å®šä¹‰å®¡æ ¸è§„åˆ™

## å®šä¹‰æ§åˆ¶è§„åˆ™

* `-b` åœ¨ Kernel ä¸­è®¾å®šæœ€å¤§æ•°é‡çš„å·²å­˜åœ¨çš„å®¡æ ¸ç¼“å†²åŒº

```
auditctl -b 8192
```

* `-f` å½“è¿½è¸ªé‡è¦é”™è¯¯æ—¶è®¾å®šæ‰€è¦å®Œæˆçš„è¡ŒåŠ¨ï¼Œä¾‹å¦‚ï¼š

```
auditctl -f 2
```

ä»¥ä¸Šé…ç½®è§¦å‘ kernel ææ…Œä»¥é˜²é‡è¦é”™è¯¯ã€‚(?)

* `-e` å¯åŠ¨æˆ–è€…ç¦ç”¨å®¡æ ¸ç³»ç»Ÿæˆ–è€…é”å®šå®ƒçš„é…ç½®ï¼Œä¾‹å¦‚ï¼š

```
auditctl -e 2
```

ä»¥ä¸Šå‘½ä»¤é”å®šå®¡æ ¸é…ç½®ã€‚

* `-r` è®¾å®šæ¯ç§’ç”Ÿæˆä¿¡æ¯çš„é€Ÿç‡ï¼Œä¾‹å¦‚ï¼š

```
auditctl -r 0
```

ä»¥ä¸Šé…ç½®åœ¨ç”Ÿæˆä¿¡æ¯æ–¹é¢ä¸è®¾å®šé™åˆ¶é€Ÿç‡ã€‚

* `-s` æŠ¥å‘Šå®¡æ ¸ç³»ç»ŸçŠ¶æ€ï¼Œä¾‹å¦‚ï¼š

```
auditctl -s
```

è¾“å‡ºä¸¾ä¾‹

```
AUDIT_STATUS: enabled=1 flag=2 pid=0 rate_limit=0 backlog_limit=8192 lost=259 backlog=0
```

* `-l` åˆ—å‡ºæ‰€æœ‰å½“å‰è£…è½½çš„å®¡æ ¸è§„åˆ™ï¼Œä¾‹å¦‚ï¼š

```
auditctl -l
```

è¾“å‡ºä¸¾ä¾‹

```
LIST_RULES: exit,always watch=/etc/localtime perm=wa key=time-change
LIST_RULES: exit,always watch=/etc/group perm=wa key=identity
LIST_RULES: exit,always watch=/etc/passwd perm=wa key=identity
LIST_RULES: exit,always watch=/etc/gshadow perm=wa key=identity
â‹®
```

* `-D` åˆ é™¤æ‰€æœ‰å½“å‰è£…è½½çš„å®¡æ ¸è§„åˆ™ï¼Œä¾‹å¦‚ï¼š

```
auditctl -D
```

## å®šä¹‰æ–‡ä»¶ç³»ç»Ÿè§„åˆ™

å®šä¹‰æ–‡ä»¶ç³»ç»Ÿè§„åˆ™ï¼š

```
auditctl -w path_to_file -p permissions -k key_name
```

* `path_to_file` æ˜¯å®¡æ ¸è¿‡çš„æ–‡ä»¶æˆ–è€…ç›®å½•
* `permissions` æ˜¯è¢«è®°å½•çš„æƒé™ï¼š
  * `r` â€” è¯»å–æ–‡ä»¶æˆ–è€…ç›®å½•ã€‚
  * `w` â€” å†™å…¥æ–‡ä»¶æˆ–è€…ç›®å½•ã€‚
  * `x` â€” è¿è¡Œæ–‡ä»¶æˆ–è€…ç›®å½•ã€‚
  * `a` â€” æ”¹å˜åœ¨æ–‡ä»¶æˆ–è€…ç›®å½•ä¸­çš„å±æ€§ã€‚
* `key_name` æ˜¯å¯é€‰å­—ç¬¦ä¸²ï¼Œå¯å¸®åŠ©æ‚¨åˆ¤å®šå“ªä¸ªè§„åˆ™æˆ–è€…å“ªç»„è§„åˆ™ç”Ÿæˆç‰¹å®šçš„æ—¥å¿—é¡¹ã€‚
â 
### å®šä¹‰æ–‡ä»¶ç³»ç»Ÿè§„åˆ™ä¸¾ä¾‹

* å®šä¹‰æ‰€æœ‰çš„è¾“å†™è®¿é—®æƒé™ä»¥åŠåœ¨ /etc/passwd æ–‡ä»¶ä¸­æ¯ä¸ªå±æ€§æ›´æ”¹çš„è§„åˆ™ï¼Œæ‰§è¡Œä»¥ä¸‹å‘½ä»¤ï¼š

```
auditctl -w /etc/passwd -p wa -k passwd_changes
```

> å­—ç¬¦ä¸² `-k` é€‰é¡¹æ˜¯ä»»æ„çš„

* è®°å½•æ‰€æœ‰è¾“å†™è®¿é—®æƒé™ï¼Œä»¥åŠåœ¨ `/etc/selinux/` ç›®å½•ä¸­æ‰€æœ‰æ–‡ä»¶å±æ€§æ›´æ”¹çš„è§„åˆ™ï¼Œæ‰§è¡Œä»¥ä¸‹å‘½ä»¤ï¼š

```
auditctl -w /etc/selinux/ -p wa -k selinux_changes
```

* å®šä¹‰å¯ä»¥è®°å½•æ‰§è¡Œ /sbin/insmod å‘½ä»¤çš„è§„åˆ™ï¼Œåœ¨ Linux Kernel ä¸­æ’å…¥æ¨¡å—ï¼Œæ‰§è¡Œä»¥ä¸‹å‘½ä»¤ï¼š

```
auditctl -w /sbin/insmod -p x -k module_insertion
```

## å®šä¹‰ç³»ç»Ÿè°ƒç”¨è§„åˆ™

ä¸ºäº†å®šä¹‰ç³»ç»Ÿè°ƒç”¨è§„åˆ™ï¼Œä½¿ç”¨ä»¥ä¸‹è¯­æ³•ï¼š

```
auditctl -a action,filter -S system_call -F field=value -k key_name
```

* `action` ä»¥åŠ `filter` è¯¦ç»†è¯´æ˜æŸä¸ªäº‹ä»¶ä½•æ—¶è¢«è®°å½•ã€‚ `action` å¯èƒ½æ˜¯ `always`ï¼ˆç»å¸¸æ˜¯ï¼‰æˆ–è€…`never`ï¼ˆä»ä¸æ˜¯ï¼‰å…¶ä¸­ä¹‹ä¸€ã€‚ `filter` è¯¦ç»†è¯´æ˜å“ªä¸ª Kernel è§„åˆ™åŒ¹é…è¿‡æ»¤å™¨åº”ç”¨åœ¨äº‹ä»¶ä¸­ã€‚ä»¥ä¸‹æ˜¯å…¶ä¸­ä¹‹ä¸€çš„ä¸è§„åˆ™åŒ¹é…çš„è¿‡æ»¤å™¨ï¼š `task`ã€`exit`ã€`user` ä»¥åŠ `exclude`ã€‚

* `system_call` é€šè¿‡å®ƒçš„åå­—è¯¦ç»†è¯´æ˜ç³»ç»Ÿè°ƒç”¨ã€‚æ‰€æœ‰çš„ç³»ç»Ÿè°ƒç”¨éƒ½å¯ä»¥åœ¨`/usr/include/asm/unistd_64.h` æ–‡ä»¶ä¸­æ‰¾åˆ°ã€‚è®¸å¤šç³»ç»Ÿè°ƒç”¨éƒ½èƒ½å½¢æˆä¸€ä¸ªè§„åˆ™ï¼Œæ¯ä¸ªéƒ½åœ¨ `-S` é€‰é¡¹ä¹‹åè¯¦ç»†è¯´æ˜ã€‚

* `field=value` è¯¦ç»†è¯´æ˜å…¶ä»–é€‰é¡¹ï¼Œè¿›ä¸€æ­¥ä¿®æ”¹è§„åˆ™æ¥ä¸ä»¥ç‰¹å®šæ¶æ„ã€ç»„ IDã€è¿›ç¨‹ IDå’Œå…¶ä»–å†…å®¹ä¸ºåŸºç¡€çš„äº‹ä»¶ç›¸åŒ¹é…ã€‚ä¸ºäº†åˆ—å‡ºå®Œæ•´å¯ç”¨çš„è¾“å…¥æ ç±»å‹å’Œå®ƒä»¬çš„æ•°å€¼ï¼Œè¯·å‚è€ƒ `auditctl(8)` æ‰‹å†Œé¡µã€‚

* `key_name` æ˜¯å¯é€‰å­—ç¬¦ä¸²ï¼Œå¯å¸®åŠ©åˆ¤å®šå“ªä¸ªè§„åˆ™æˆ–è€…å“ªç»„è§„åˆ™ç”Ÿæˆç‰¹å®šçš„æ—¥å¿—é¡¹ã€‚

### å®šä¹‰ç³»ç»Ÿè°ƒç”¨è§„åˆ™ä¸¾ä¾‹

* ä¸ºäº†å®šä¹‰åˆ›é€ æ—¥å¿—é¡¹ çš„è§„åˆ™ï¼Œæ¯æ¬¡é€šè¿‡ç¨‹åºä½¿ç”¨ç³»ç»Ÿè°ƒç”¨ adjtimex æˆ–è€… settimeofdayã€‚å½“ç³»ç»Ÿä½¿ç”¨ 64 ä½æ¶æ„ï¼Œè¯·æ‰§è¡Œä»¥ä¸‹å‘½ä»¤ï¼š

```
auditctl -a always,exit -F arch=b64 -S adjtimex -S settimeofday -k time_change
```

* ä¸ºäº†å®šä¹‰åˆ›é€ æ—¥å¿—é¡¹çš„è§„åˆ™ï¼Œæ¯æ¬¡ç”± ID æ˜¯ 500 æˆ–æ›´å¤§çš„ç³»ç»Ÿç”¨æˆ·åˆ é™¤æˆ–è€…é‡å‘½åæ–‡ä»¶æ—¶ï¼Œä½¿ç”¨ï¼ˆ`-F auid!=4294967295` é€‰é¡¹æ’é™¤æ²¡æœ‰è®¾å®šç™»å½• UIDçš„ç”¨æˆ·ï¼‰ï¼Œæ‰§è¡Œä»¥ä¸‹å‘½ä»¤ï¼š

```
auditctl -a always,exit -S unlink -S unlinkat -S rename -S renameat -F auid>=500 -F auid!=4294967295 -k delete
```

* ä½¿ç”¨ç³»ç»Ÿè°ƒç”¨è¯­æ³•æ¥å®šä¹‰æ–‡ä»¶ç³»ç»Ÿä¹Ÿæ˜¯æœ‰å¯èƒ½çš„ã€‚å¯¹äº `-w /etc/shadow -p wa`æ–‡ä»¶ç³»ç»Ÿè§„åˆ™æ¥è¯´ï¼Œä»¥ä¸‹å‘½ä»¤ä¸ºæ¨¡æ‹Ÿçš„ç³»ç»Ÿè°ƒç”¨åˆ›é€ äº†è§„åˆ™ï¼š

```
auditctl -a always,exit -F path=/etc/shadow -F perm=wa
```

## åœ¨ `/etc/audit/audit.rules` æ–‡ä»¶ä¸­å®šä¹‰æŒä¹…çš„å®¡æ ¸è§„åˆ™å’Œæ§åˆ¶

### å®šä¹‰æ§åˆ¶è§„åˆ™

æ–‡ä»¶å¯ä»¥åªåŒ…æ‹¬ä»¥ä¸‹çš„æ§åˆ¶è§„åˆ™ï¼Œä¿®æ”¹å®¡æ ¸ç³»ç»Ÿçš„è¡Œä¸ºï¼š -bã€-Dã€-eã€-fã€æˆ–è€… -rã€‚

* åœ¨ audit.rulesä¸­æ§åˆ¶è§„åˆ™

```
# Delete all previous rules
-D

# Set buffer size
-b 8192

# Make the configuration immutable -- reboot is required to change audit rules
-e 2

# Panic when a failure occurs
-f 2

# Generate at most 100 audit messages per second
-r 100
```

### â å®šä¹‰æ–‡ä»¶ç³»ç»Ÿå’Œç³»ç»Ÿè°ƒç”¨è§„åˆ™

ä½¿ç”¨ auditctl è¯­æ³•å®šä¹‰æ–‡ä»¶ç³»ç»Ÿå’Œç³»ç»Ÿè°ƒç”¨åŸåˆ™ã€‚åœ¨ä¸Šè¿°çš„ä¾‹å­å¯ä»¥ç”¨ä»¥ä¸‹è§„åˆ™æ–‡ä»¶æ¥è¡¨ç¤ºï¼š

```
-w /etc/passwd -p wa -k passwd_changes
-w /etc/selinux/ -p wa -k selinux_changes
-w /sbin/insmod -p x -k module_insertion

-a always,exit -F arch=b64 -S adjtimex -S settimeofday -k time_change
-a always,exit -S unlink -S unlinkat -S rename -S renameat -F auid>=500 -F auid!=4294967295 -k delete
```

## é¢„é…ç½®è§„åˆ™æ–‡ä»¶

åœ¨ `/usr/share/doc/audit-version/` ç›®å½•ä¸­, æ ¹æ®ä¸åŒçš„è®¤è¯æ ‡å‡† audit è½¯ä»¶åŒ…æä¾›ä¸€ç»„é¢„é…ç½®è§„åˆ™æ–‡ä»¶ï¼š

* nispom.rules â€” å®¡æ ¸è§„åˆ™é…ç½®ç¬¦åˆã€Šå›½å®¶è¡Œä¸šå®‰å…¨ç¨‹åºæ“ä½œè¿è¡ŒæŒ‡å—ã€‹çš„ç¬¬å…«ç« ä¸­è¯¦ç»†è¯´æ˜çš„è¦æ±‚ã€‚
* capp.rules â€” å®¡æ ¸è§„åˆ™é…ç½®æ»¡è¶³ç”± CAPP è®¾å®šçš„è¦æ±‚ï¼Œæ˜¯å…¬å…±æ ‡å‡†è®¤å®šçš„ä¸€éƒ¨åˆ†ã€‚
* lspp.rules â€”å®¡æ ¸è§„åˆ™é…ç½®æ»¡è¶³ç”± LSPP è®¾å®šçš„è¦æ±‚æ˜¯å…¬å…±æ ‡å‡†è®¤å®šçš„ä¸€éƒ¨åˆ†ã€‚
* stig.rules â€” å®¡æ ¸è§„åˆ™é…ç½®æ»¡è¶³ç”± STIG æ‰€è®¾å®šçš„è¦æ±‚ã€‚

ä¸ºäº†ä½¿ç”¨è¿™äº›é…ç½®æ–‡ä»¶ï¼Œéœ€è¦åŸå§‹æ–‡ä»¶çš„å¤‡ä»½ `/etc/audit/audit.rules `å¹¶ä¸”å¤åˆ¶é€‰æ‹©çš„æœ‰å…³ `/etc/audit/audit.rules` æ–‡ä»¶çš„é…ç½®æ–‡ä»¶:

```
cp /etc/audit/audit.rules /etc/audit/audit.rules_backup
cp /usr/share/doc/audit-version/stig.rules /etc/audit/audit.rules
```

# ç†è§£å®¡æ ¸æ—¥å¿—æ–‡ä»¶

é»˜è®¤æƒ…å†µä¸‹ï¼Œåœ¨ `/var/log/audit/audit.log` æ–‡ä»¶ä¸­çš„å®¡æ ¸ç³»ç»Ÿå‚¨å­˜æ—¥å¿—é¡¹ï¼›å¦‚æœå¯ç”¨æ—¥å¿—æ—‹è½¬ï¼Œå°±å¯ä»¥æ—‹è½¬å‚¨å­˜åœ¨åŒä¸€ç›®å½•ä¸­çš„ `audit.log` æ–‡ä»¶ã€‚

ä»¥ä¸‹çš„å®¡æ ¸è§„åˆ™è®°å½•äº†æ¯æ¬¡è¯»å–æˆ–è€…ä¿®æ”¹ `/etc/ssh/sshd_config` æ–‡ä»¶çš„å°è¯•ï¼š

```
-w /etc/ssh/sshd_config -p warx -k sshd_config
```

å¦‚æœ auditd å®ˆæŠ¤ç¨‹åºåœ¨è¿è¡Œï¼Œå°±éœ€åœ¨å®¡æ ¸æ—¥å¿—æ–‡ä»¶ä¸­è¿è¡Œä»¥ä¸‹å‘½ä»¤åˆ›é€ æ–°äº‹ä»¶ï¼š

```
~]# cat /etc/ssh/sshd_config
```

åœ¨ `audit.log` æ–‡ä»¶ä¸­çš„äº‹ä»¶å¦‚ä¸‹æ‰€ç¤ºï¼š

```
type=SYSCALL msg=audit(1364481363.243:24287): arch=c000003e syscall=2 success=no exit=-13 a0=7fffd19c5592 a1=0 a2=7fffd19c4b50 a3=a items=1 ppid=2686 pid=3538 auid=500 uid=500 gid=500 euid=500 suid=500 fsuid=500 egid=500 sgid=500 fsgid=500 tty=pts0 ses=1 comm="cat" exe="/bin/cat" subj=unconfined_u:unconfined_r:unconfined_t:s0-s0:c0.c1023 key="sshd_config"
type=CWD msg=audit(1364481363.243:24287):  cwd="/home/shadowman"
type=PATH msg=audit(1364481363.243:24287): item=0 name="/etc/ssh/sshd_config" inode=409248 dev=fd:00 mode=0100600 ouid=0 ogid=0 rdev=00:00 obj=system_u:object_r:etc_t:s0
```

ä»¥ä¸Šäº‹ä»¶ç”±ä¸‰ä¸ªè®°å½•ç»„æˆï¼ˆæ¯ä¸ªä»¥ `type=`ä½œä¸ºå¼€å§‹ï¼‰ï¼Œå…±äº«ç›¸åŒçš„æ—¶é—´æˆ³å’Œç¼–å·ã€‚æ¯ä¸ªè®°å½•åŒ…å«å¥½å‡ å¯¹ `name=value `ï¼Œç”±ç©ºæ ¼æˆ–è€…é€—å·åˆ†å¼€ã€‚ä»¥ä¸‹æ˜¯å…³äºä»¥ä¸Šäº‹ä»¶çš„è¯¦ç»†åˆ†æï¼š

## ç¬¬ä¸€ä¸ªè®°å½•

* `type=SYSCALL`

type è¾“å…¥æ åŒ…å«è¿™ç±»è®°å½•ã€‚åœ¨è¿™ä¸ªä¾‹å­ä¸­ï¼Œ SYSCALL æ•°å€¼è¯¦ç»†è¯´æ˜è¿æ¥åˆ° Kernel çš„ç³»ç»Ÿè°ƒç”¨è§¦å‘äº†è¿™ä¸ªè®°å½•ã€‚

> æ‰€æœ‰å¯èƒ½çš„ç±»å‹å€¼å’Œå®ƒä»¬çš„è§£é‡Šï¼Œè¯·å‚è€ƒ [å®¡æ ¸è®°å½•ç±»å‹](https://access.redhat.com/documentation/zh-CN/Red_Hat_Enterprise_Linux/7/html/Security_Guide/sec-Audit_Record_Types.html)ã€‚

* `msg=audit(1364481363.243:24287):`
  * audit(time_stamp:ID) è¡¨æ ¼ä¸­è®°å½•çš„æ—¶é—´æˆ³å’Œç‰¹æ®Š IDã€‚å¦‚æœå¤šç§è®°å½•ç”Ÿæˆä¸º **ç›¸åŒå®¡æ ¸äº‹ä»¶çš„ä¸€éƒ¨åˆ†ï¼Œé‚£ä¹ˆå®ƒä»¬å¯ä»¥å…±äº«ç›¸åŒçš„æ—¶é—´æˆ³å’ŒID**ã€‚
  * Kernel æˆ–è€…ç”¨æˆ·ç©ºé—´åº”ç”¨æä¾›ä¸åŒçš„äº‹ä»¶ç‰¹å®š `name=value` ç»„ã€‚

# å‚è€ƒ

* [çº¢å¸½ä¼ä¸šç‰ˆLinux 7: å®‰å…¨æ€§æŒ‡å— - ç³»ç»Ÿå®¡æ ¸](https://access.redhat.com/documentation/zh-CN/Red_Hat_Enterprise_Linux/7/html/Security_Guide/chap-system_auditing.html)